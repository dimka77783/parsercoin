#!/bin/bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CRON_FILE="/tmp/crypto_parser_cron"

echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –∑–∞–¥–∞—á–∞–º–∏
cat > "$CRON_FILE" << EOF
# Crypto Parser - –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞
0 */4 * * * $SCRIPT_DIR/run_parser_with_db.sh >> $SCRIPT_DIR/logs/cron.log 2>&1

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
0 3 * * * $SCRIPT_DIR/backup_db.sh >> $SCRIPT_DIR/logs/backup.log 2>&1

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ - —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
0 2 * * 0 find $SCRIPT_DIR/logs -name "parser_*.log" -mtime +30 -delete

EOF

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ
echo "üìã –ë—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏:"
echo "-----------------------------------"
cat "$CRON_FILE"
echo "-----------------------------------"

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∏ –∑–∞–¥–∞—á–∏ –≤ cron? (y/n) " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π crontab
    crontab -l > /tmp/current_cron 2>/dev/null || true

    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    cat /tmp/current_cron "$CRON_FILE" | crontab -

    echo "‚úÖ –ó–∞–¥–∞—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ cron"
    echo ""
    echo "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞—á–∏: crontab -l"
    echo "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: crontab -e"
else
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f "$CRON_FILE"